name: Free Windows RDP

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Windows VM with RDP
      run: |
        sudo apt update
        sudo apt install -y qemu-system-x86 wget curl unzip

        echo "Downloading Windows image..."
        wget -O windows.img https://go.microsoft.com/fwlink/?linkid=2156292

        echo "Setting up Tailscale..."
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-rdp --ssh

        echo "Enabling RDP multi-session..."
        # Create autounattend setup for multiple sessions
        cat <<EOF > enable-multi-rdp.reg
        Windows Registry Editor Version 5.00

        [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server]
        "fSingleSessionPerUser"=dwor
